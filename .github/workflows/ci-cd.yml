name: CI/CD Pipeline

on:
  push:
   branches: 
        - main
  pull_request:
        branches:
        - main

jobs:
    build:
     name: build
     runs-on: ubuntu-latest  

     steps:
         - name: Checkout Code
           uses: actions/checkout@v3

         - name: Setup Node.js
           uses: actions/setup-node@v3
           with:
               node-version: '20'

         - name: Install Dependencies
           run: npm install

         -  name: Run Unit Tests
            run: npm test   

    depoly:
      name:   Deploy App
      runs-on: ubuntu-latest
      needs: build
      if: github.ref == 'refs/heads/main'   

      steps:
        - name: Checkout Code
          uses: actions/checkout@v3

        - name: Install Dependencies
          run: npm install  

        - name: Build for release
          run:    |
              cd android
              ./gradlew assembleRelease

          env:
           NODE_OPTIONS: '--max_old_space_size=4096'   

        - name: Upload Artifacr
          uses: actions/upload-artifact@v3
          with:
            name: android-release-apk
            path: android/app/build/outputs/apk/release/app-releaser.apk

        - name: Deploy to Play Store
          run: |
               fastlane supply init
               fastlane supply run
          env:
             SUPPLY_JSON_KEY: ${{ secrets.GOOGLE_PLAY_API_JSON }} 


        - name: Deploy to Firebase
          run: |
           firebase appdistribution:distribute android/app/build/outputs/apk/release/app-release.apk \
           --app APP_ID \
           --groups testers

